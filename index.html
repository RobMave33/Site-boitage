<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Bo√Ætage Manager - V42 (Reset Fix)</title>
  
  <link rel="icon" href="logo.png" type="image/png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    /* --- STYLE V42 --- */
    :root { --bg:#0f172a; --panel:#1e293b; --text:#f8fafc; --border:#334155; --accent:#3b82f6; --danger:#ef4444; --success:#22c55e; --map-bg:#111; }
    body.light-mode { --bg:#fff; --panel:#f1f5f9; --text:#0f172a; --border:#e2e8f0; --map-bg:#e5e5e5; }
    body.light-mode .leaflet-tile-pane { filter: none !important; }
    body.light-mode .poi-label { color: #000; text-shadow: 0 0 2px #fff; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); }
    body.light-mode .card { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    body.light-mode input { background: #fff; }
    body.light-mode .app-logo { background: transparent; box-shadow: none; }

    body { margin:0; display:grid; grid-template-columns:350px 1fr; height:100vh; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; }
    aside { background:var(--panel); border-right:1px solid var(--border); padding:20px; display:flex; flex-direction:column; gap:15px; z-index:1001; box-shadow: 4px 0 24px rgba(0,0,0,0.2); overflow-y: auto; }
    
    .app-logo { width: 120px; height: 120px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .card { background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .bar { height:8px; background:rgba(0,0,0,0.3); border-radius:99px; overflow:hidden; margin-top:12px; }
    .fill { height:100%; width:0%; background:var(--success); transition:width 0.5s; }

    input { width:100%; background:var(--bg); border:1px solid var(--border); padding:12px; border-radius:8px; color:var(--text); outline:none; box-sizing:border-box; }
    button { width:100%; padding:12px; border-radius:8px; border:none; font-weight:600; cursor:pointer; background:var(--accent); color:#fff; transition:0.2s; }
    
    #map { height:100%; width:100%; background:var(--map-bg); z-index: 1; }
    .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

    /* POI / ZONES */
    .poi-marker { display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    .poi-emoji { font-size: 28px; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5)); z-index:20; }
    .poi-label { font-size: 11px; font-weight: 700; color: #fff; text-shadow: 0 0 3px #000; text-align: center; white-space: nowrap; margin-top: -2px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; backdrop-filter: blur(4px); }

    /* LOADER & STATUS */
    #loader { position:fixed; inset:0; background:var(--bg); z-index:9999; display:grid; place-items:center; transition:opacity 0.5s; pointer-events: none; }
    .spinner { width:40px; height:40px; border:4px solid var(--accent); border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    #status-indicator { position: absolute; bottom: 120px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; gap: 8px; align-items: center; backdrop-filter: blur(4px); pointer-events: none; opacity: 0; transition: opacity 0.3s; }
    
    /* MOBILE UI */
    #mobile-header, #mobile-footer, #mobile-gps { display: none; }
    @media (max-width: 768px) { 
      body { grid-template-columns: 1fr; } aside { display: none !important; }
      #mobile-header { display: block; position: absolute; top: 15px; left: 15px; right: 15px; z-index: 2000; }
      #mobile-header input { background: var(--panel); border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.3); color: var(--text); }
      #mobile-gps { display: grid; place-items: center; position: absolute; bottom: 160px; right: 20px; z-index: 2000; width: 56px; height: 56px; border-radius: 50%; background: var(--panel); border: 2px solid var(--accent); color: var(--accent); font-size: 26px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; }
      #mobile-footer { display: block; position: absolute; bottom: 0; left: 0; right: 0; z-index: 2000; background: var(--panel); border-top: 1px solid var(--border); padding: 20px 15px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.4); }
      .mobile-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
    }
  </style>
</head>
<body class="light-mode">

  <div id="mobile-header"><input id="search-mobile" placeholder="üîç Rechercher rue..." onkeydown="if(event.key==='Enter') searchAddr('mobile')" /></div>
  <button id="mobile-gps" onclick="locateUser()">üéØ</button>
  <div id="mobile-footer">
    <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; font-weight:600"><span>Avancement</span> <span id="pct-mobile" style="color:var(--success)">0%</span></div>
    <div class="bar" style="margin-top:0"><div id="fill-mobile" class="fill"></div></div>
    <div class="mobile-row"><button onclick="sync()" id="btn-save-mobile" style="font-size:16px; padding:14px;">‚òÅÔ∏è Enregistrer</button></div>
  </div>

  <div id="loader"><div style="text-align:center"><div class="spinner" style="margin:0 auto 20px;"></div><div>Chargement carte...</div></div></div>

  <aside>
    <div style="text-align:center; margin-bottom:10px;">
        <img src="logo.png" alt="Logo" class="app-logo" onerror="this.style.display='none'" />
        <h1 style="margin:5px 0 0 0; font-size:22px;">Bo√Ætage Manager</h1>
        <div style="font-size:12px; opacity:0.7">Ambar√®s-et-Lagrave</div>
    </div>
    
    <div class="card">
      <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:600"><span>Avancement</span><span style="color:var(--success)" id="pct">0%</span></div>
      <div class="bar"><div id="fill" class="fill"></div></div>
      <div style="font-size:12px; margin-top:8px; opacity:0.7" id="count">0 / 0 rues</div>
    </div>
    <input id="search" placeholder="üîç Rechercher une rue..." onkeydown="if(event.key==='Enter') searchAddr('pc')" />
    <div style="flex:1; overflow-y:auto; padding-right:5px;">
      <div style="font-size:12px; font-weight:bold; margin-bottom:10px;">Lieux (Zones)</div>
      <div id="poi-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button onclick="loadRoads(true)" style="background:#475569; border:1px solid #334155;">üîÑ Recharger Carte</button>
      <button onclick="locateUser()" style="background:#0f766e; border:1px solid #115e59;">üéØ Ma Position</button>
      <button onclick="sync()" id="btn-save-pc">‚òÅÔ∏è Sauvegarder</button>
      <button style="background:transparent; border:1px solid var(--border); color:var(--text);" onclick="document.body.classList.toggle('light-mode')">üåó Mode Jour / Nuit</button>
      <button style="background:rgba(239,68,68,0.2); border:1px solid var(--danger); color:var(--danger);" onclick="resetData()">üóëÔ∏è HARD RESET</button>
    </div>
  </aside>

  <div style="position:relative; height:100%; width:100%;">
    <div id="map"></div>
    <div id="status-indicator"><div class="spinner" style="width:14px; height:14px; border-width:2px;"></div><span id="status-text">Chargement rues...</span></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === CONFIGURATION ===
    // Met bien l'URL de ton dernier script d√©ploy√© ici
    const SYNC_URL = "https://script.google.com/macros/s/AKfycbyq-2DtXXrF_1hFKBtBnXDeYxAiJs4bpRhMXqXVuTzgofjcQgVPPxbda86R5Jn8pi899w/exec";
    const SYNC_TOKEN = "Agir33"; const SYNC_KEY = "ambares";
    const EXCLUDE = new Set(["avenue des guerlandes","rue de la chenaie"]);
    
    // ZONES
    const SECTORS = [
      { id: 1, lat: 44.92654, lng: -0.49043, emoji: "üèõÔ∏è", color: "#e6194B", name: "H√¥tel De Ville", keywords: ["coty","faulat","aubrac","bonheur","victoire","gua","hontasse","flamants","cormorans","cigognes","albatros","goelands","herons","leclerc","cabane","morand","terrasson","eiffel","tilleuls","clos saint pierre","prieure","hugo","dulong","lalanne","sicaire","poetes","coteau","beauvoir","beregovoy","ramadie","lacanau"] },
      { id: 2, lat: 44.92333156985766, lng: -0.5002552494572793, emoji: "üè´", color: "#3cb44b", name: "√âc. Prim. Bel Air", keywords: ["ormeaux","monimeau","sabareges","zola","martet","lignac","jambes","champeau","guillaume","tretins","lyonnais","combes","jaures","sable","bois vert","sicart","picoutous","industries","loup","formont","val de bares","orion","sagittaires","gemeaux","verseaux","chanterelles","goboles","coutins","campanie","marquet"] },
      { id: 3, lat: 44.93807, lng: -0.48740, emoji: "üß∏", color: "#ffe119", name: "Mat. Ch. Perrault", keywords: ["lamarque","jouvet","bedichaud","printemps","canton","liberte","lamartine","lagrave","ribeyrotte","pol","fort","brassens","jacques","prevert","brel","merlet","pontet","treuil","verlaine","villon","st michel","st georges","pergola","michaelis","parabelle","agnans","page"] },
      { id: 4, lat: 44.92987, lng: -0.49666, emoji: "üè´", color: "#4363d8", name: "Ambar√®s II", keywords: ["ferry","prat","1962","mandela","cogedim","carteau","vivaldi","saisons","reinhardt","vian","coluche","barbere","oeil","musset","canteranne","napoleon","chene","liberation","gare","salengro","signoret","auriol","moulin","foch","vierge","templiers"] },
      { id: 5, lat: 44.92926, lng: -0.47280, emoji: "üå≥", color: "#f58231", name: "Mat. J. Lagrave", keywords: ["chauvet","loubes","ricodonne","linder","alouette","hourcade","beausejour","brandier","croix noire","malleret","larrieu","poteau","gaes","chevreuse","fontainebleau","anjou","enghien","tirelaon","hostein","argenteuil","barre","clairiere","taudin","roseraie","peupliers"] },
      { id: 6, lat: 44.92684, lng: -0.48795, emoji: "üé≠", color: "#911eb4", name: "Auditorium", keywords: ["pre des places","tassigny","beauvais","marcel pol","marceau","parc des sports","republique","marche","herriot","kelheim","mendes","gaulle","roses","camus","jourdane","coude","bernatet","clanis","albizzias","roy"] },
      { id: 7, lat: 44.93188, lng: -0.50327, emoji: "üëµ", color: "#42d4f4", name: "RPA Le Moulin", keywords: ["blanche","beaujet","montferrand","courtefesse","grain","cabanne","pelet","chateau du gua","chemin de la vie","grandjean","bauvais","monastere","badaunes","saint denis","quinsus","garouilla","peychaud","picon","merle","coiffard","barot","bout du parc","lestonnat","nole","maransins","saint laurent","aillabau"] },
      { id: 8, lat: 44.95143, lng: -0.49663, emoji: "üè´", color: "#f032e6", name: "√âc. Simone Veil", keywords: ["placeots","brechet","durandeau","baraille","chataignier","pousseguere","batailley","protestant","ponchut","moinesse","bernadat","levant"] },
      { id: 9, lat: 44.92351, lng: -0.49920, emoji: "üçΩÔ∏è", color: "#bfef45", name: "Bel Air (Europe)", keywords: ["gorp","pasteur","braille","bassens","europe","carbon","mouline","amandine","pensees","tillac","causselles","villas","hauts"] },
      { id: 10, lat: 44.93151, lng: -0.49357, emoji: "üèòÔ∏è", color: "#fabed4", name: "Self Blandats", keywords: ["broustey","ponticelli","couderc","lalande","lousteauneuf","saint sever","lavoisier","ampere","places","albaladejo"] },
      { id: 11, lat: 44.93569, lng: -0.48065, emoji: "üè´", color: "#008080", name: "√âc. F. Auboin", keywords: ["blum","palacin","thorez","jarry","clemenceau","duras","jaugues","marsillon","sauvin","gazillon","azalees","verdo","rabaneau","erables","barrus","vergers","aubepine","muriers"] }
    ];

    let map, layerGroup, zonesLayer, markersLayer;
    let roads = [], sessionBlue = new Set(), persistedBlue = new Set();
    let pendingDeletions = new Set(); 



// Journal d'op√©rations (multi-user):
// - cl√© = nom de rue normalis√©
// - valeur = timestamp sign√© (positif = BLEU, n√©gatif = ROUGE)
// -> merge fiable entre plusieurs utilisateurs (last-write-wins par rue)
let opLog = {};

const DONE_STORAGE_KEY = "boitage_v42_done";
const DEL_STORAGE_KEY  = "boitage_v42_del";
const OPS_STORAGE_KEY  = "boitage_v42_ops";
    const normalize = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
    const OVERPASS_CACHE_KEY = `overpass_roads_cache_${SYNC_KEY}_v42_final`;

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    function pointKey(lat, lon) { return Math.round(lat/1e-4) + "|" + Math.round(lon/1e-4); }
    function setStatus(msg, show = true) {
      const el = document.getElementById('status-indicator'); if (!el) return; el.style.opacity = show ? '1' : '0';
      const t = document.getElementById('status-text'); if (t) t.textContent = msg;
    }

    // --- LOGIQUE RESEAU (ROBUSTE) ---
    async function fetchOverpass(query) {
      const ENDPOINTS = ["https://overpass-api.de/api/interpreter", "https://overpass.kumi.systems/api/interpreter", "https://overpass.openstreetmap.ru/api/interpreter"];
      for (let attempt = 0; attempt < 3; attempt++) {
        try {
          setStatus(`Chargement rues... (${attempt+1}/3)`, true);
          const res = await fetch(ENDPOINTS[attempt%ENDPOINTS.length], { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "data=" + encodeURIComponent(query) });
          if (!res.ok) throw new Error("HTTP error");
          return await res.json();
        } catch (e) { await sleep(1500); }
      }
      throw new Error("Impossible de charger la carte");
    }

    async function loadRoads(forceReload = false) {
      if(!forceReload) {
          try {
            const raw = localStorage.getItem(OVERPASS_CACHE_KEY);
            if (raw) {
               const obj = JSON.parse(raw);
               if (Date.now() - obj.ts < 24 * 3600 * 1000) { 
                   roads = obj.roads;
                   renderRues(); updateStats(); drawZonesAndPoints();
                   setStatus("Cache OK", true); setTimeout(()=>setStatus("",false),1000);
                   return;
               }
            }
          } catch(e) {}
      }

      setStatus("Chargement rues...", true);
      const q = `[out:json][timeout:25];area["name"="Ambar√®s-et-Lagrave"]->.a;way(area.a)["highway"~"^(residential|living_street|unclassified|road|service|primary|secondary|tertiary)$"]["name"]->.named;node(w.named)->.n;way(area.a)(bn.n)["highway"~"^(residential|unclassified|service)$"][!"name"]->.connected;(.named; .connected;);out geom;`;
      
      try {
        const json = await fetchOverpass(q);
        const temp = []; const els = json.elements || [];
        for (let i = 0; i < els.length; i++) {
          const e = els[i]; const norm = e.tags?.name ? normalize(e.tags.name) : "unnamed";
          if (EXCLUDE.has(norm)) continue;
          let sec = null; for (const s of SECTORS) { if (s.keywords.some(k => norm.includes(k))) { sec = s; break; } }
          const geom = e.geometry || []; if (!geom.length) continue;
          temp.push({ name: e.tags?.name, norm, lines: geom.map(p => [p.lat, p.lon]), sector: sec, type: e.tags?.name ? 'named' : 'unnamed' });
        }
        
        // Linkage des impasses sans nom
        const named = temp.filter(r => r.type === 'named'); const unnamed = temp.filter(r => r.type === 'unnamed');
        const idx = new Map(); named.forEach(r => r.lines.forEach(p => { const k=pointKey(p[0],p[1]); if(!idx.has(k)) idx.set(k,[]); idx.get(k).push(r.norm); }));
        unnamed.forEach(u => {
           const s=u.lines[0], e=u.lines[u.lines.length-1];
           const c = (idx.get(pointKey(s[0],s[1])) || []).concat(idx.get(pointKey(e[0],e[1])) || []);
           if(c.length) { u.linkedTo = c[0]; const p = named.find(n=>n.norm===c[0]); if(p?.sector) u.sector = p.sector; }
        });

        roads = [...named, ...unnamed];
        localStorage.setItem(OVERPASS_CACHE_KEY, JSON.stringify({ ts: Date.now(), roads: roads }));
        renderRues(); updateStats(); drawZonesAndPoints(); setStatus("OK", true); setTimeout(() => setStatus("", false), 1000);
      } catch (e) {
        setStatus("Erreur r√©seau", true); 
        alert("Erreur chargement. Appuyez sur 'Recharger Carte'.");
      }
    }

    // --- RENDU ET CLIC (FIX IMPASSE) ---
    function renderRues() {
      layerGroup.clearLayers();
      roads.forEach(r => {
        let isDone = false;
        // Si c'est une impasse li√©e, elle prend la couleur de sa rue "m√®re"
        if (r.norm === "unnamed" && r.linkedTo) isDone = sessionBlue.has(r.linkedTo) || persistedBlue.has(r.linkedTo);
        else isDone = sessionBlue.has(r.norm) || persistedBlue.has(r.norm);
        
        const color = isDone ? "#3b82f6" : "#ef4444";
        const vis = L.polyline(r.lines, { color, weight: isDone?4:3, opacity:0.9 });
        
        // ZONE DE CLIC AGRANDIE (30px)
        const hit = L.polyline(r.lines, { color:'transparent', weight:30, interactive:true }).on('click', () => {
           // D√©termine quelle rue on cible vraiment
           const target = (r.norm === "unnamed" && r.linkedTo) ? r.linkedTo : r.norm;
           if(target === "unnamed") return; // Rue orpheline, on ignore
           
           // Si c'est une impasse li√©e, on r√©cup√®re le "vrai" nom pour l'affichage
           let displayName = r.name || ("Impasse de " + target);
           if(r.norm === "unnamed" && r.linkedTo) {
               // On cherche le nom propre de la rue li√©e
               const parent = roads.find(x => x.norm === r.linkedTo);
               if(parent && parent.name) displayName = `Impasse li√©e √† : ${parent.name}`;
           }

           const done = sessionBlue.has(target) || persistedBlue.has(target);
           const action = done ? "Remettre en ROUGE ?" : "Valider en BLEU ?";
           
           if(confirm(`${action}\n\n${displayName}`)) {
             if(done) { 
    // LOGIQUE "BLEU -> ROUGE"
    const ts = Date.now();
    sessionBlue.delete(target); persistedBlue.delete(target);
    pendingDeletions.add(target);
    opLog[target] = -ts;
} else { 
    // LOGIQUE "ROUGE -> BLEU"
    const ts = Date.now();
    sessionBlue.add(target); persistedBlue.add(target);
    pendingDeletions.delete(target);
    opLog[target] = ts;
}
             saveLocal(); renderRues(); updateStats();
           }
        });
        layerGroup.addLayer(L.layerGroup([vis, hit]));
      });
    }

    // --- ALGORITHME ZONES ---
    function clip(poly, A, B, C) {
      if(!poly.length) return []; const out = [];
      for(let i=0; i<poly.length; i++){
        const s = poly[i], e = poly[(i+1)%poly.length];
        const ds = A*s.x + B*s.y - C, de = A*e.x + B*e.y - C;
        if(ds<=0 && de<=0) out.push(e);
        else if(ds<=0 && de>0) { const t=ds/(ds-de); out.push({x:s.x+t*(e.x-s.x), y:s.y+t*(e.y-s.y)}); }
        else if(ds>0 && de<=0) { const t=ds/(ds-de); out.push({x:s.x+t*(e.x-s.x), y:s.y+t*(e.y-s.y)}); out.push(e); }
      }
      return out;
    }
    function drawZonesAndPoints() {
      if(!map) return;
      const nw = map.latLngToLayerPoint([44.9824, -0.5375]); 
      const se = map.latLngToLayerPoint([44.9131, -0.4507]);
      let poly = [{x:nw.x,y:nw.y}, {x:se.x,y:nw.y}, {x:se.x,y:se.y}, {x:nw.x,y:se.y}];
      const seeds = SECTORS.map(s => { const p = map.latLngToLayerPoint([s.lat, s.lng]); return {x:p.x, y:p.y, ...s}; });
      zonesLayer.clearLayers(); markersLayer.clearLayers();
      seeds.forEach(site => {
        L.marker([site.lat, site.lng], {
          icon: L.divIcon({ className: 'poi-marker', html: `<div class="poi-emoji">${site.emoji}</div><div class="poi-label">${site.name}</div>`, iconSize: [120,50], iconAnchor: [60,25] }), interactive: false
        }).addTo(markersLayer);
        let cell = [...poly];
        seeds.forEach(other => {
          if(site.id===other.id) return;
          const A = 2*(other.x - site.x), B = 2*(other.y - site.y);
          const C = (other.x*other.x + other.y*other.y) - (site.x*site.x + site.y*site.y);
          cell = clip(cell, A, B, C);
        });
        if(cell.length>2) L.polygon(cell.map(p=>map.layerPointToLatLng(p)), { color:'#000', weight:1, fillOpacity:0.25, fillColor:site.color, interactive:false }).addTo(zonesLayer);
      });
    }

    // --- STATS & STORAGE ---
    function updateStats() {
      const u = new Set(roads.map(r=>r.norm).filter(n=>n!=="unnamed")); const d = new Set([...sessionBlue, ...persistedBlue]).size; const p = u.size ? Math.round((d/u.size)*100) : 0;
      document.getElementById('pct').textContent = p+"%"; document.getElementById('fill').style.width = p+"%";
      document.getElementById('count').textContent = d + " / " + u.size;
      document.getElementById('pct-mobile').textContent = p+"%"; document.getElementById('fill-mobile').style.width = p+"%";
    }
    

function loadLocal(){
    // Nouveau format (opLog) + compat ancien format (done/del)
    try { opLog = JSON.parse(localStorage.getItem(OPS_STORAGE_KEY) || "{}") || {}; } catch { opLog = {}; }

    let doneSet = new Set();
    let delSet = new Set();
    try { doneSet = new Set(JSON.parse(localStorage.getItem(DONE_STORAGE_KEY) || "[]")); } catch {}
    try { delSet  = new Set(JSON.parse(localStorage.getItem(DEL_STORAGE_KEY)  || "[]")); } catch {}

    // Compat: si opLog est vide mais qu'on a une liste 'done', on seed opLog (sans timestamp)
    if (Object.keys(opLog).length === 0 && doneSet.size) {
      doneSet.forEach(k => { if (typeof k === 'string' && k) opLog[k] = 1; });
    }
    // Compat: appliquer les suppressions en n√©gatif
    delSet.forEach(k => { if (typeof k === 'string' && k) opLog[k] = -Math.abs(opLog[k] || 1); });

    // Rebuild sets √† partir de opLog
    persistedBlue = new Set();
    pendingDeletions = new Set();
    for (const [k, v] of Object.entries(opLog)) {
      if (typeof v !== 'number' || !k) continue;
      if (v > 0) persistedBlue.add(k);
      else if (v < 0) pendingDeletions.add(k);
    }
    // On garde sessionBlue align√© pour ne rien casser ailleurs
    sessionBlue = new Set([...persistedBlue]);
}

function saveLocal(){
    // Sauvegarde du nouveau format + compat (done/del)
    localStorage.setItem(OPS_STORAGE_KEY, JSON.stringify(opLog));
    localStorage.setItem(DONE_STORAGE_KEY, JSON.stringify([...persistedBlue]));
    localStorage.setItem(DEL_STORAGE_KEY, JSON.stringify([...pendingDeletions]));
}
        // --- RESET CORRIG√â ---
    async function resetData(){ 
        if(prompt("Mot de passe RESET ?") === "Romane33") {
            if(confirm("‚ö†Ô∏è ATTENTION: Cela va passer TOUTES les rues en ROUGE (local + cloud, pour tout le monde).\n\nContinuer ?")) {
                const btn = document.querySelector('button[onclick="resetData()"]');
                const old = btn.textContent; btn.textContent = "Passage au rouge...";
                try {
                    const ts = Date.now();

                    // 0) R√©cup√©rer les cl√©s du cloud pour √™tre s√ªr de tout repasser en rouge
                    let serverKeys = [];
                    try {
                      const r0 = await fetch(`${SYNC_URL}?token=${SYNC_TOKEN}&key=${SYNC_KEY}`);
                      const d0 = await r0.json();
                      if (d0 && d0.ops && typeof d0.ops === 'object' && !Array.isArray(d0.ops)) serverKeys = Object.keys(d0.ops);
                      else if (d0 && Array.isArray(d0.values)) serverKeys = d0.values.filter(v => typeof v === 'string');
                    } catch(e) {}

                    // 1) Construire la liste "toutes les rues" (donn√©es carte + cloud + local)
                    const all = new Set();
                    (roads || []).forEach(r => {
                      if (r && r.norm && r.norm !== "unnamed") all.add(r.norm);
                      if (r && r.linkedTo && r.linkedTo !== "unnamed") all.add(r.linkedTo);
                    });
                    serverKeys.forEach(k => { if (k) all.add(k); });
                    Object.keys(opLog || {}).forEach(k => { if (k) all.add(k); });

                    // 2) Forcer ROUGE partout (timestamp sign√© n√©gatif) -> override multi-user
                    const redOps = {};
                    all.forEach(k => { redOps[k] = -ts; });

                    opLog = redOps;
                    sessionBlue = new Set();
                    persistedBlue = new Set();
                    pendingDeletions = new Set(all);

                    saveLocal();
                    renderRues(); updateStats();

                    // 3) Sauvegarder au cloud
                    await fetch(SYNC_URL, {
                        method: "POST",
                        body: JSON.stringify({ token:SYNC_TOKEN, key:SYNC_KEY, ops:opLog, values:[] })
                    });

                    btn.textContent = old;
                    alert("‚úÖ OK : toutes les rues sont repass√©es en rouge et sauvegard√©es.");
                } catch(e) {
                    alert("Erreur RESET. V√©rifiez connexion.");
                    btn.textContent = old;
                }
            }
        }
    }

    
// --- SYNC ---

async function sync(){
  saveLocal();
  const bPC = document.getElementById('btn-save-pc'); const bMob = document.getElementById('btn-save-mobile');
  const oldTxtPC = bPC.textContent;
  bPC.textContent = "‚è≥"; bMob.textContent = "‚è≥";
  try {
    // 1) Pull Cloud (nouveau format: {ops:{...}})
    const r1 = await fetch(`${SYNC_URL}?token=${SYNC_TOKEN}&key=${SYNC_KEY}`);
    const d1 = await r1.json();

    // Compat: si le cloud renvoie seulement une liste, on la convertit en ops
    let serverOps = {};
    if (d1 && d1.ops && typeof d1.ops === 'object' && !Array.isArray(d1.ops)) {
      serverOps = d1.ops;
    } else if (d1 && Array.isArray(d1.values)) {
      const baseTs = 1; // ancien √©tat (pas d'horodatage)
      d1.values.forEach(k => { if (typeof k === 'string' && k) serverOps[k] = baseTs; });
    }

    // 2) Merge c√¥t√© client (par rue): on garde l'op la plus r√©cente (abs(timestamp))
    const mergedOps = { ...serverOps };
    for (const [k, v] of Object.entries(opLog)) {
      if (typeof v !== 'number' || !k) continue;
      const cur = mergedOps[k];
      if (typeof cur !== 'number' || Math.abs(v) > Math.abs(cur)) mergedOps[k] = v;
    }
    opLog = mergedOps;

    // 3) Rebuild sets
    persistedBlue = new Set();
    pendingDeletions = new Set();
    for (const [k, v] of Object.entries(opLog)) {
      if (typeof v !== 'number' || !k) continue;
      if (v > 0) persistedBlue.add(k);
      else if (v < 0) pendingDeletions.add(k);
    }
    sessionBlue = new Set([...persistedBlue]);

    saveLocal();
    renderRues(); updateStats();

    // 4) Push merged ops to cloud
    await fetch(SYNC_URL, {
      method: "POST",
      body: JSON.stringify({ token:SYNC_TOKEN, key:SYNC_KEY, ops:opLog, values:[...persistedBlue] })
    });

    bPC.textContent = "‚úÖ"; bMob.textContent = "‚úÖ";
    setTimeout(()=>{ bPC.textContent=oldTxtPC; bMob.textContent="‚òÅÔ∏è Enregistrer"; }, 2000);
  } catch(e) {
    alert("Sync HS");
    bPC.textContent=oldTxtPC; bMob.textContent="‚òÅÔ∏è Enregistrer";
  }
}

function searchAddr(s) {

        const id = s === 'mobile' ? 'search-mobile' : 'search';
        const v = normalize(document.getElementById(id).value);
        const hit = roads.find(r => r.norm.includes(v));
        if(hit) { map.fitBounds(L.polyline(hit.lines).getBounds(), {padding:[50,50]}); }
    }

    function locateUser() {
        map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
    }

    // --- START ---
    window.addEventListener('DOMContentLoaded', () => {
      map = L.map('map', {zoomControl:false}).setView([44.925, -0.49], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OSM' }).addTo(map);
      
      map.createPane('gpsPane'); map.getPane('gpsPane').style.zIndex = 650;
      zonesLayer = L.layerGroup().addTo(map); markersLayer = L.layerGroup().addTo(map); layerGroup = L.layerGroup().addTo(map);

      const lst = document.getElementById('poi-list');
      SECTORS.forEach(s => {
        lst.innerHTML += `<div style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid #334155;" onclick="map.setView([${s.lat},${s.lng}], 17)">
          <span style="font-size:18px">${s.emoji}</span><span style="color:${s.color};font-weight:bold;font-size:11px;">${s.name}</span></div>`;
      });
      
      map.on('locationfound', function(e) {
          map.eachLayer((layer) => { if(layer._isUserLocation) map.removeLayer(layer); });
          const c = L.circleMarker(e.latlng, { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, opacity: 1, fillOpacity: 1, pane: 'gpsPane' }).addTo(map);
          const a = L.circle(e.latlng, e.accuracy, { color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.15, weight: 0, pane: 'gpsPane' }).addTo(map);
          c._isUserLocation = true; a._isUserLocation = true;
      });

      document.getElementById('loader').style.display='none';
      loadLocal();
      locateUser();
      loadRoads();
      sync();
    });
  </script>
</body>
</html>
